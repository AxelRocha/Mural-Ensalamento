var path = require('path');

var app = require(path.resolve(__dirname, '../server/server'));
var ds = app.datasources.ensalamento;

ds.automigrate('Bloco', function(err) {
    if (err) throw err;
    var blocos = [
        {localizacao: '0,0', tamanho: 10},
        {localizacao: '0,0', tamanho: 10}
    ];

    var count = blocos.length;
    blocos.forEach(function(bloco) {
        app.models.Bloco.create(bloco, function(err, model) {
            if (err) throw err;
            console.log('Created:', model);

            count--;
            if (count === 0)
                ds.disconnect();
        });
    });
});

ds.automigrate('Sala', function(err) {
    if (err) throw err;

    var salas = [
        {localizacao: '41.12,-71.34', capacidade: 10, tipo:"teste", restrita:false},
        {localizacao: '41.12,-71.34', capacidade: 10, tipo:"teste", restrita:true}
    ];

    var count = salas.length;
    salas.forEach(function(sala) {
        app.models.Sala.create(sala, function(err, model) {
            if (err) throw err;
            console.log('Created:', model);
            count--;
            if (count === 0)
                ds.disconnect();
        });
    });
});

ds.automigrate('User', function(err) {
    if (err) throw err;
    app.models.User.create([
      {username: 'admin', email: 'admin@admin.com', password: '123mudar'}
    ],function(err, users) {
        if (err) throw err;
        console.log('Created users:', users);
        app.models.Role.create({
            name: 'admin'
        }, function(err, role) {
            if (err) throw err;
            console.log('Created role:', role);
            role.principals.create({
                principalType: RoleMapping.USER,
                principalId: users[0].id
            }, function(err, principal) {
                if (err) throw err;
                console.log('Assign admin Role to initial User:', users[0].email);
            });
        });
    });

    ds.disconnect();
});
